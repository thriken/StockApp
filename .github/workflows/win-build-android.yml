name: WIN Android CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: windows-2022
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        java-package: jdk

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    # 【关键步骤1】手动下载 Gradle 到项目根目录
    - name: Manually Download Gradle
      shell: powershell
      run: |
        Write-Host "Downloading Gradle from GitHub releases..."
        # 使用 Invoke-WebRequest 从 GitHub 下载，这比 Gradle 自己的下载器更可靠
        Invoke-WebRequest -Uri "https\://services.gradle.org/distributions/gradle-8.14-all.zip" -OutFile "gradle-8.14-all.zip"
        Write-Host "Download complete. File saved to gradle-8.4-all.zip"

    # 【关键步骤2】修改 gradle-wrapper.properties 以使用本地文件
    - name: Configure Gradle Wrapper to use Local Distribution
      shell: powershell
      run: |
        Write-Host "Configuring gradle-wrapper.properties to use the local distribution..."
        # 将 distributionUrl 替换为指向项目根目录下文件的相对路径
        # gradle/wrapper/ -> ../.. -> 项目根目录
        (Get-Content gradle/wrapper/gradle-wrapper.properties) -replace 'distributionUrl=.*', 'distributionUrl=../../gradle-8.14-all.zip' | Set-Content gradle/wrapper/gradle-wrapper.properties
        Write-Host "Configuration updated. Content is now:"
        Get-Content gradle/wrapper/gradle-wrapper.properties # 打印出来确认修改成功
        nslookup google.com

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v2
    - name: Build with Gradle
      run: ./gradlew build
      env:
        ANDROID_NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
        ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: app-release
        path: app/build/outputs/apk/release/
